<!DOCTYPE html>
<html lang="en" ng-app="zmxk">
<head>

<!-- start: Meta -->
<meta charset="utf-8" />
<title>Smartool</title>
<meta name="description" content="Smartool" />
<meta name="author" content="Mac Fang" />
<meta name="keyword" content="Smartool" />
<!-- end: Meta -->

<!-- start: Mobile Specific -->
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- end: Mobile Specific -->

<!-- start: CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet" />
<link href="css/bootstrap-responsive.min.css" rel="stylesheet" />
<link href="css/style.min.css" rel="stylesheet" />
<link href="css/style-responsive.min.css" rel="stylesheet" />
<link href="css/retina.css" rel="stylesheet" />
<!-- end: CSS -->


<!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
	  	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<link id="ie-style" href="css/ie.css" rel="stylesheet">
	<![endif]-->

<!--[if IE 9]>
		<link id="ie9style" href="css/ie9.css" rel="stylesheet">
	<![endif]-->

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body ng-controller="MainController as main">

	<!-- start: Header -->
	<div class="navbar" ng-include="'header_nav_bar.html'"></div>
	<div class="container-fluid-full">
		<div class="row-fluid">
			<div id="sidebar-left" class="span2" ng-include="'side_nav_bar.html'"></div>
			<!-- end: Main Menu -->

			<!-- start: Content -->
			<div id="content" class="span10">
				<div class="row-fluid" ng-include="includePage()"></div>
			</div>
			<!-- end: Content -->

		</div>
		<!--/fluid-row-->

		<div class="modal hide fade" id="myModal">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">×</button>
				<h3>Settings</h3>
			</div>
			<div class="modal-body">
				<p>Here settings can be configured...</p>
			</div>
			<div class="modal-footer">
				<a href="#" class="btn" data-dismiss="modal">Close</a> <a href="#"
					class="btn btn-primary">Save changes</a>
			</div>
		</div>

		<div class="clearfix" ng-include="'footer.html'"></div>

	</div>
	<!--/.fluid-container-->

	<!-- start: JavaScript-->
	<script src="js/jquery-1.10.2.min.js"></script>
	<script src="js/angular.min.js"></script>
	<script src="js/angular-resource.min.js"></script>
	<script src="js/jquery-migrate-1.2.1.min.js"></script>
	<script src="js/jquery-ui-1.10.3.custom.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src='js/fullcalendar.min.js'></script>
	<script src='js/jquery.dataTables.min.js'></script>


	<script src="js/jquery.chosen.min.js"></script>
	<script src="js/jquery.uniform.min.js"></script>
	<script src="js/jquery.cleditor.min.js"></script>
	<script src="js/jquery.noty.js"></script>
	<script src="js/jquery.elfinder.min.js"></script>
	<script src="js/jquery.raty.min.js"></script>
	<script src="js/jquery.uploadify-3.1.min.js"></script>
	<script src="js/jquery.gritter.min.js"></script>
	<script src="js/jquery.imagesloaded.js"></script>
	<script src="js/jquery.masonry.min.js"></script>
	<script src="js/jquery.knob.modified.js"></script>
	<script src="js/jquery.sparkline.min.js"></script>

	<script src="js/jquery.autosize.min.js"></script>
	<script src="js/retina.js"></script>
	<script src="js/jquery.placeholder.min.js"></script>
	<script src="js/wizard.min.js"></script>
	<script src="js/core.min.js"></script>
	<script src="js/charts.min.js"></script>
	<script src="js/custom.min.js"></script>
	<script>
		var currentModule = "users";
		var zmxk = angular.module('zmxk', [ 'ngResource' ]);
		// Event Service
		zmxk.service('eventService', [ '$resource', 'zmxkConfig', '$q',
				function($resource, zmxkConfig, $q) {
					var eventResource = $resource(zmxkConfig.event_rest_uri, {
						eventId : '@id'
					}, {
						saveAttendee : {
							url : zmxkConfig.event_add_attendee_uri,
							method : "POST",
							headers : {
								'Content-Type' : 'application/json'
							}
						}
					})
					this.list = function() {
						var defer = $q.defer();
						eventResource.query(function(data, headers) {
							defer.resolve(data);
						}, function(data, headers) {
							defer.reject(data);
						});
						return defer.promise;
					}

					this.addAttendee = function(eventId, attendeeData) {
						var defer = $q.defer();
						eventResource.saveAttendee({
							eventId : eventId
						}, attendeeData, function(body, headers) {
							console.log(body.data);
							defer.resolve(body);
						}, function(body, headers) {
							console.log(body.data);
							defer.reject(body);
						})
						return defer.promise;
					}
				} ]);
		// User Service 
		zmxk
				.service(
						'userService',
						[
								'$resource',
								'zmxkConfig',
								'$q',
								function($resource, zmxkConfig, $q) {
									var usersResource = $resource(
											zmxkConfig.user_rest_uri,
											{
												userId : '@id'
											},
											{
												login : {
													url : zmxkConfig.user_login_uri,
													method : 'Post',
													headers : {
														'Content-Type' : 'application/x-www-form-urlencoded'
													}
												},
												logout : {
													url : zmxkConfig.user_logout_uri,
													method : 'Post'
												}
											})
									this.login = function() {
										//TODO
									};

									this.register = function() {
										//TODO
									}

									this.list = function() {
										var users = usersResource
												.query(function(data) {
													console.log(data);
												});
									}

									this.getUser = function(giveUserId) {
										var defer = $q.defer();
										usersResource.get({
											userId : giveUserId
										}, function(user, headers) {
											defer.resolve(user);
										}, function(user, headers) {
											defer.reject(user);
										});
										return defer.promise;
									}

								} ]);
		//put all labels / constants in
		zmxk.constant('zmxkConstant', {

		});

		zmxk
				.value(
						'zmxkConfig',
						{
							user_login_uri : "/service/api/v1/users/login",
							user_logout_uri : "/service/api/v1/users/logout",
							user_rest_uri : "/service/smartool/api/v1/users/:userId",
							event_rest_uri : "/service/smartool/api/v1/events/:eventId",
							event_add_attendee_uri : "/service/smartool/api/v1/events/:eventId/attendees"
						});

		zmxk.config([ '$resourceProvider', function($resourceProvider) {
			// Don't strip trailing slashes from calculated URLs
			$resourceProvider.defaults.stripTrailingSlashes = false;
		} ]);

		zmxk.controller('MainController', [
				'$scope',
				'$location',
				'userService',
				function($scope, $location, userService) {
					console.log(userService);

					$scope.$location = $location;

					$scope.userId = $scope.$location.search().userId;

					$scope.includePage = function() {
						var returnPage = "user_list.html";
						switch (currentModule) {
						case "userList":
							returnPage = "user_list.html";
							break;
						case "eventList":
							returnPage = "event_list.html";
							break;
						case "eventEnroll":
							returnPage = "event_enroll.html";
							break
						}
						return returnPage;
					}

					$scope.init = function() {
						//TODO: init if no cookie token, return to login page
						//userService.list();

						if (!angular
								.isUndefined($scope.$location.search().page)) {
							//console.log($scope.userId);
							currentModule = $scope.$location.search().page;
						}
					}

					$scope.init();
				} ]);
		//MainController.$inject = ['$scope', 'userService'];

		//Main end

		zmxk.controller('SideBarController', [ '$scope', function($scope) {
			/*var mainCtrlScope = $scope.$new();
			
			$controller('MainController',{$scope : mainCtrlScope });*/
			$scope.processPages = function(pageType) {
				currentModule = pageType;
				//console.log(currentPage);
			}
			//console.log($scope.userId);

		} ]);
		//Enroll Start
		zmxk
				.controller(
						'EnrollController',
						[
								'$scope',
								'userService',
								'eventService',
								function($scope, userService, eventService) {
									$scope.enroll_form_data = {};
									$scope.enroll_form_data.kids = [];
									$scope.kidsToShow = [];
									$scope.found_user = {};
									$scope.totalSteps = 0;
									$scope.currentStep = 1;
									$scope.steps = [];
									$scope.previous_label = "上一步";
									$scope.next_label = "下一步";
									$scope.events = [ {
										eventTime : "2015/07/04",
										currentAttendeeNum : 15,
										eventId : "12345"
									}, {
										eventTime : "2015/07/05",
										currentAttendeeNum : 16,
										eventId : "67890"
									}, {
										eventTime : "2015/07/06",
										currentAttendeeNum : 17,
										eventId : "24680"
									} ];
									//FIXME
									$scope.kids_school_options = [ {
										value : 0,
										label : "幼儿园"
									}, {
										value : 1,
										label : "小学"
									}, {
										value : 2,
										label : "未上幼儿园"
									} ]

									$scope.addChild = function() {
										var kid = {};
										kid["existed"] = false;
										$scope.kidsToShow.push(kid);
									}

									$scope.selectStep = function(step) {

										if ($scope.currentStep > 0
												&& $scope.currentStep + step <= $scope.totalSteps) {
											$scope.currentStep = $scope.currentStep
													+ step;
										}
										//change label
										if ($scope.currentStep == $scope.totalSteps) {
											$scope.next_label = "提交";
										} else {
											$scope.next_label = "下一步";
										}
									}

									$scope.selectEvent = function(eventId) {
										$scope.enroll_form_data.eventId = eventId;
										console.log($scope.enroll_form_data);
									}

									$scope.processForm = function() {
										for (var i = 0; i < $scope.kidsToShow.length; i++) {
											var kid = $scope.kidsToShow[i];
											console.log(kid);
											if (kid.selected) {
												$scope.enroll_form_data.kids
														.push(kid);
											}
										}
										//TODO call Kid API to create Kid
										var returnAttendees = [];
										for (var j = 0; j < $scope.enroll_form_data.kids.length; j++) {
											var kid = $scope.enroll_form_data.kids[j];
											var attendee = {};
											attendee["kidId"] = kid.id;
											attendee["userId"] = kid.userId;
											eventService
													.addAttendee(
															$scope.enroll_form_data.eventId,
															attendee)
													.then(
															function(data) {
																returnAttendees.push(data);
																if(returnAttendees.length == $scope.enroll_form_data.kids.length) {
																	console.log("successs !");
																}
															}, function(error) {
																//TODO
															})

										}

										//console.log($scope.enroll_form_data);

									}

									$scope.searchUser = function() {
										console
												.log($scope.enroll_form_data.userQueryString)
										//TODO from user API
										$scope.found_user.id = "12313123";
										$scope.found_user.name = "Mac Fang";
										$scope.found_user.mobileNum = "13706516916";
									}

									$scope.chooseUser = function() {
										$scope.enroll_form_data.name = $scope.found_user.name;
										$scope.enroll_form_data.mobileNum = $scope.found_user.mobileNum;
									}

									$scope.init = function() {
										//TODO get from user api
										if (!angular.isUndefined($scope.userId)) {
											//"9c1cc2b5-ee76-41f2-bd92-a1161a92dda6" - Mac Fang
											userService
													.getUser($scope.userId)
													.then(
															function(user) {

																if (!angular
																		.isUndefined(user.kids)) {

																	for (var i = 0; i < user.kids.length; i++) {
																		var kid = user.kids[i];
																		kid["existed"] = true;
																		$scope.kidsToShow
																				.push(kid);
																	}
																}
																//TODO, 
																$scope.enroll_form_data.userId = user.id;
																$scope.enroll_form_data.name = user.name
																$scope.enroll_form_data.mobileNum = user.mobileNum;
																$scope.enroll_form_data.kidName = "弘毅";
																$scope.enroll_form_data.wcId = user.wcId;
															}, function(error) {
																//TODO
															});
										}
										if (!$scope.noUserIdPassed()) {
											$scope.totalSteps = 2;
											$scope.steps = [ 1, 2 ];
										} else {
											$scope.totalSteps = 3;
											$scope.steps = [ 1, 2, 3 ];
										}

										//TODO : call eventServie to list events 
										eventService
												.list()
												.then(
														function(data) {
															console
																	.log("then events ~~~");
															$scope.events = data;

															//console.log($scope.events);

														}, function(error) {
															//TODO
														});

									}

									$scope.noUserIdPassed = function() {
										return angular
												.isUndefined($scope.userId);
									}

									$scope.formatDate = function(timestamp) {
										var dateOut = new Date(timestamp);
										return dateOut;
									};

									$scope.init();
								} ]);
		//init
		//angular.element(document).ready(function () {
		//	mainControllerScope.init();
		//});
	</script>
	<!-- end: JavaScript-->

</body>
</html>